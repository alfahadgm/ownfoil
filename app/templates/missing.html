{% extends "base.html" %}

{% block content %}
{% include 'nav.html' %}
<div id="content" class="container-fluid mt-3">
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Missing Base Games</h5>
                    <p class="card-text display-4" id="missingBaseCount">0</p>
                    <p class="card-text">DLC/Updates without base game</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Missing Updates</h5>
                    <p class="card-text display-4" id="missingUpdateCount">0</p>
                    <p class="card-text">Games with newer versions available</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-info">
                <div class="card-body">
                    <h5 class="card-title">Missing DLC</h5>
                    <p class="card-text display-4" id="missingDlcCount">0</p>
                    <p class="card-text">Games without all available DLC</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Tips -->
    <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
        <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> Search Tips</h6>
        <p class="mb-0">Searches now use simplified queries for better results. When searching:</p>
        <ul class="mb-0">
            <li>Base games: Searches for just the game name</li>
            <li>Updates: Searches for game name + "update"</li>
            <li>DLC: Searches for game name + "DLC"</li>
        </ul>
        <small>After searching, look for the Title ID in the torrent filenames or descriptions to find the correct content.</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-auto">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#missingBaseSection" aria-expanded="true">
                <i class="bi bi-controller"></i> Base Games (<span class="missing-base-count">0</span>)
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#missingUpdateSection" aria-expanded="true">
                <i class="bi bi-arrow-up-circle"></i> Updates (<span class="missing-update-count">0</span>)
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#missingDlcSection" aria-expanded="true">
                <i class="bi bi-puzzle"></i> DLC (<span class="missing-dlc-count">0</span>)
            </button>
        </div>
        <div class="col-auto ms-auto">
            <button class="btn btn-secondary" id="exportBtn">
                <i class="bi bi-download"></i> Export List
            </button>
        </div>
    </div>

    <!-- Missing Base Games Section -->
    <div class="collapse show" id="missingBaseSection">
        <h3 class="mb-3">Missing Base Games</h3>
        <div class="row g-3" id="missingBaseGrid">
            <!-- Content loaded dynamically -->
        </div>
        <hr class="my-4">
    </div>

    <!-- Missing Updates Section -->
    <div class="collapse show" id="missingUpdateSection">
        <h3 class="mb-3">Missing Updates</h3>
        <div class="row g-3" id="missingUpdateGrid">
            <!-- Content loaded dynamically -->
        </div>
        <hr class="my-4">
    </div>

    <!-- Missing DLC Section -->
    <div class="collapse show" id="missingDlcSection">
        <h3 class="mb-3">Missing DLC</h3>
        <div class="row g-3" id="missingDlcGrid">
            <!-- Content loaded dynamically -->
        </div>
    </div>

</div>

<!-- Active Downloads Section -->
<div class="mb-4" id="activeDownloadsSection" style="display: none;">
    <h3 class="mb-3">
        <i class="bi bi-download"></i> Active Downloads
        <button class="btn btn-sm btn-secondary float-end" onclick="toggleAutoRefresh()">
            <i class="bi bi-arrow-clockwise"></i> <span id="autoRefreshText">Auto-refresh: ON</span>
        </button>
    </h3>
    <div class="row g-3" id="activeDownloadsGrid">
        <!-- Downloads will be loaded here -->
    </div>
    <hr class="my-4">
</div>

<!-- Loading Spinner -->
<div class="text-center my-5" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Jackett Configuration Modal -->
<div class="modal fade" id="jackettConfigModal" tabindex="-1" aria-labelledby="jackettConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jackettConfigModalLabel">Configure Jackett URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="jackettUrlInput" class="form-label">Jackett URL:</label>
                    <input type="url" class="form-control" id="jackettUrlInput" placeholder="http://localhost:9117">
                    <div class="form-text">Enter your Jackett instance URL (e.g., http://localhost:9117)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveJackettUrl()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Jackett Search Results Modal -->
<div class="modal fade" id="jackettSearchModal" tabindex="-1" aria-labelledby="jackettSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jackettSearchModalLabel">Search Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="searchLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-2">Searching torrents...</p>
                </div>
                <div id="searchError" class="alert alert-danger d-none" role="alert"></div>
                <div id="searchResults" class="d-none">
                    <div class="mb-3">
                        <span id="searchResultCount"></span>
                        <button class="btn btn-sm btn-secondary float-end" onclick="openJackettWeb()">
                            <i class="bi bi-box-arrow-up-right"></i> Open in Jackett
                        </button>
                        <div class="text-muted small mt-2">
                            <i class="bi bi-info-circle"></i> Click the download button to send torrents directly to qBittorrent
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Size</th>
                                    <th>Seeders</th>
                                    <th>Leechers</th>
                                    <th>Indexer</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    let missingData = null;
    let jackettUrl = localStorage.getItem('jackettUrl') || '';
    let activeDownloads = new Map(); // Track active downloads by hash
    let autoRefreshEnabled = true;
    let refreshInterval = null;

    function fetchMissingContent() {
        $('#loadingSpinner').show();
        $('#content').hide();
        
        $.get('/api/missing', function(data) {
            missingData = data;
            renderMissingContent(data);
            $('#loadingSpinner').hide();
            $('#content').show();
        }).fail(function() {
            $('#loadingSpinner').hide();
            alert('Failed to load missing content data');
        });
    }

    function renderMissingContent(data) {
        // Update summary counts
        $('#missingBaseCount').text(data.summary.total_missing_base);
        $('#missingUpdateCount').text(data.summary.total_missing_updates);
        $('#missingDlcCount').text(data.summary.total_missing_dlc);
        
        $('.missing-base-count').text(data.missing_base.length);
        $('.missing-update-count').text(data.missing_updates.length);
        $('.missing-dlc-count').text(data.missing_dlc.length);
        
        // Render missing base games
        renderMissingBase(data.missing_base);
        
        // Render missing updates
        renderMissingUpdates(data.missing_updates);
        
        // Render missing DLC
        renderMissingDlc(data.missing_dlc);
    }

    function renderMissingBase(items) {
        const grid = $('#missingBaseGrid');
        grid.empty();
        
        if (items.length === 0) {
            grid.append('<div class="col-12"><p class="text-muted">No missing base games found!</p></div>');
            return;
        }
        
        items.forEach(item => {
            const card = $(`
                <div class="col-md-6 col-lg-4">
                    <div class="card text-bg-dark h-100">
                        <img src="${item.bannerUrl || ''}" class="card-img-top" alt="${item.name}" onerror="this.style.display='none'">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <p class="card-text">
                                <small class="text-muted">Title ID: ${item.title_id}</small><br>
                                ${item.has_updates ? '<span class="badge bg-warning me-1">Has Updates</span>' : ''}
                                ${item.has_dlcs ? '<span class="badge bg-info">Has DLC</span>' : ''}
                            </p>
                            <div class="mt-2">
                                <strong>Owned files:</strong>
                                <ul class="small">
                                    ${item.owned_files.map(f => `<li>${f.filename}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-success me-1" onclick="smartSearch('${item.name}', 'base', '${item.title_id}')" 
                                        title="Search and filter results within ownfoil (requires API key)">
                                    <i class="bi bi-lightning"></i> Smart Search
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="searchInJackett('${item.name}', 'base', '${item.title_id}')" 
                                        title="Search for game name only. Look for Title ID [${item.title_id}] in the results.">
                                    <i class="bi bi-search"></i> Quick Search
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="copySearchQuery('${item.name}', 'base', '${item.title_id}')"
                                        title="Copy simplified search query to clipboard">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            grid.append(card);
        });
    }

    function renderMissingUpdates(items) {
        const grid = $('#missingUpdateGrid');
        grid.empty();
        
        if (items.length === 0) {
            grid.append('<div class="col-12"><p class="text-muted">All games are up to date!</p></div>');
            return;
        }
        
        items.forEach(item => {
            const card = $(`
                <div class="col-md-6 col-lg-4">
                    <div class="card text-bg-dark h-100">
                        <img src="${item.bannerUrl || ''}" class="card-img-top" alt="${item.name}" onerror="this.style.display='none'">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <p class="card-text">
                                <small class="text-muted">Title ID: ${item.title_id}</small><br>
                                ${item.has_base ? '<span class="badge bg-success me-1">Has Base</span>' : '<span class="badge bg-danger me-1">No Base</span>'}
                                <span class="badge bg-secondary">Current: v${item.current_version || 0}</span>
                                <span class="badge bg-primary">Latest: v${item.latest_version}</span>
                            </p>
                            <div class="mt-2">
                                <strong>Missing versions:</strong>
                                <ul class="small">
                                    ${item.missing_versions.map(v => `<li>v${v.version} (${v.release_date})</li>`).join('')}
                                </ul>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-success me-1" onclick="smartSearch('${item.name}', 'update', '${item.title_id}', '${item.latest_version}')" 
                                        title="Search and filter results within ownfoil (requires API key)">
                                    <i class="bi bi-lightning"></i> Smart Search
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="searchInJackett('${item.name}', 'update', '${item.title_id}', '${item.latest_version}')"
                                        title="Search for '${item.name} update'. Look for v${item.latest_version} and Title ID [${item.title_id}] in results.">
                                    <i class="bi bi-search"></i> Quick Search
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="copySearchQuery('${item.name}', 'update', '${item.title_id}', '${item.latest_version}')"
                                        title="Copy simplified search query to clipboard">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            grid.append(card);
        });
    }

    function renderMissingDlc(items) {
        const grid = $('#missingDlcGrid');
        grid.empty();
        
        if (items.length === 0) {
            grid.append('<div class="col-12"><p class="text-muted">All games have complete DLC!</p></div>');
            return;
        }
        
        items.forEach(item => {
            const card = $(`
                <div class="col-md-6 col-lg-4">
                    <div class="card text-bg-dark h-100">
                        <img src="${item.bannerUrl || ''}" class="card-img-top" alt="${item.name}" onerror="this.style.display='none'">
                        <div class="card-body">
                            <h5 class="card-title">${item.name}</h5>
                            <p class="card-text">
                                <small class="text-muted">Title ID: ${item.title_id}</small><br>
                                <span class="badge bg-info">${item.owned_dlc}/${item.total_dlc} DLC owned</span>
                            </p>
                            <div class="mt-2">
                                <strong>Missing DLC:</strong>
                                <ul class="small">
                                    ${item.missing_dlcs.map(d => `<li>${d.name} (${d.app_id})</li>`).join('')}
                                </ul>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-success me-1" onclick="smartSearchDLC('${item.name}', '${item.title_id}', ${JSON.stringify(item.missing_dlcs).replace(/"/g, '&quot;')})" 
                                        title="Search and filter results within ownfoil (requires API key)">
                                    <i class="bi bi-lightning"></i> Smart Search
                                </button>
                                <button class="btn btn-sm btn-primary me-1" onclick="searchInJackettDLC('${item.name}', '${item.title_id}', ${JSON.stringify(item.missing_dlcs).replace(/"/g, '&quot;')})"
                                        title="Search for '${item.name} DLC'. Look for specific DLC names and Title IDs in results.">
                                    <i class="bi bi-search"></i> Quick Search
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="copyDLCSearchQuery('${item.name}', ${JSON.stringify(item.missing_dlcs).replace(/"/g, '&quot;')})"
                                        title="Copy simplified search query to clipboard">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            grid.append(card);
        });
    }

    function exportMissingList() {
        if (!missingData) return;
        
        let text = "OWNFOIL MISSING CONTENT REPORT\n";
        text += "================================\n\n";
        text += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        text += "SUMMARY\n";
        text += "-------\n";
        text += `Missing Base Games: ${missingData.summary.total_missing_base}\n`;
        text += `Missing Updates: ${missingData.summary.total_missing_updates}\n`;
        text += `Missing DLC: ${missingData.summary.total_missing_dlc}\n\n`;
        
        if (missingData.missing_base.length > 0) {
            text += "MISSING BASE GAMES\n";
            text += "------------------\n";
            missingData.missing_base.forEach(item => {
                text += `- ${item.name} [${item.title_id}]\n`;
                text += `  Status: ${item.has_updates ? 'Has Updates' : ''} ${item.has_dlcs ? 'Has DLC' : ''}\n`;
                text += `  Owned files:\n`;
                item.owned_files.forEach(f => {
                    text += `    - ${f.filename}\n`;
                });
                text += "\n";
            });
        }
        
        if (missingData.missing_updates.length > 0) {
            text += "\nMISSING UPDATES\n";
            text += "----------------\n";
            missingData.missing_updates.forEach(item => {
                text += `- ${item.name} [${item.title_id}]\n`;
                text += `  Current version: v${item.current_version || 0}\n`;
                text += `  Latest version: v${item.latest_version}\n`;
                text += `  Missing versions:\n`;
                item.missing_versions.forEach(v => {
                    text += `    - v${v.version} (${v.release_date})\n`;
                });
                text += "\n";
            });
        }
        
        if (missingData.missing_dlc.length > 0) {
            text += "\nMISSING DLC\n";
            text += "------------\n";
            missingData.missing_dlc.forEach(item => {
                text += `- ${item.name} [${item.title_id}]\n`;
                text += `  DLC Status: ${item.owned_dlc}/${item.total_dlc} owned\n`;
                text += `  Missing DLC:\n`;
                item.missing_dlcs.forEach(d => {
                    text += `    - ${d.name} [${d.app_id}]\n`;
                });
                text += "\n";
            });
        }
        
        // Create and download the file
        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ownfoil-missing-content-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function saveJackettUrl() {
        jackettUrl = $('#jackettUrlInput').val().trim();
        if (jackettUrl && !jackettUrl.endsWith('/')) {
            jackettUrl += '/';
        }
        localStorage.setItem('jackettUrl', jackettUrl);
        $('#jackettConfigModal').modal('hide');
    }
    
    function cleanGameName(gameName) {
        // Remove special characters and symbols that interfere with searches
        return gameName
            .replace(/™/g, '')      // Remove trademark symbol
            .replace(/®/g, '')      // Remove registered symbol
            .replace(/©/g, '')      // Remove copyright symbol
            .replace(/[:]/g, '')    // Remove colons
            .replace(/['']/g, "'")  // Normalize apostrophes
            .replace(/[""]/g, '"')  // Normalize quotes
            .replace(/\s+/g, ' ')   // Normalize multiple spaces
            .trim();                // Remove leading/trailing spaces
    }
    
    function buildSearchQuery(gameName, type, titleId, version) {
        // Clean the game name first
        let query = cleanGameName(gameName);
        
        if (type === 'base') {
            // Just search for the game name
            return query;
        } else if (type === 'update') {
            // Add "update" keyword for updates
            return `${query} update`;
        }
        
        return query;
    }
    
    function buildDLCSearchQuery(gameName, dlcList) {
        // Clean the game name and do simple search
        let query = cleanGameName(gameName);
        return `${query} DLC`;
    }
    
    function buildAdvancedSearchQuery(gameName, type, titleId, version) {
        // Keep the old complex query for advanced/manual searches but clean the name
        let query = cleanGameName(gameName);
        
        if (type === 'base') {
            query += ` (NSP OR NSZ OR XCI OR XCZ)`;
            if (titleId) {
                query += ` [${titleId}]`;
            }
        } else if (type === 'update') {
            query += ` (update OR patch)`;
            if (version) {
                query += ` v${version}`;
            }
            query += ` (NSP OR NSZ)`;
            if (titleId) {
                query += ` [${titleId.substring(0, 13)}800]`;
            }
        }
        
        return query;
    }
    
    function buildAdvancedDLCSearchQuery(gameName, dlcList) {
        let query = cleanGameName(gameName);
        let dlcNames = dlcList.map(d => `"${d.name}"`).join(' OR ');
        return `${query} DLC (${dlcNames}) (NSP OR NSZ)`;
    }
    
    function searchInJackett(gameName, type, titleId, version) {
        if (!jackettUrl) {
            // Load from automation settings first
            $.get('/api/settings/automation', function(result) {
                if (result.success && result.automation?.jackett?.url) {
                    jackettUrl = result.automation.jackett.url;
                    if (jackettUrl && !jackettUrl.endsWith('/')) {
                        jackettUrl += '/';
                    }
                    localStorage.setItem('jackettUrl', jackettUrl);
                    performSearch(gameName, type, titleId, version);
                } else {
                    $('#jackettUrlInput').val(jackettUrl);
                    $('#jackettConfigModal').modal('show');
                }
            }).fail(function() {
                $('#jackettUrlInput').val(jackettUrl);
                $('#jackettConfigModal').modal('show');
            });
        } else {
            performSearch(gameName, type, titleId, version);
        }
    }
    
    function performSearch(gameName, type, titleId, version) {
        const query = buildSearchQuery(gameName, type, titleId, version);
        const searchUrl = `${jackettUrl}UI/Dashboard#search=${encodeURIComponent(query)}&tracker=&category=`;
        window.open(searchUrl, '_blank');
    }
    
    function searchInJackettDLC(gameName, titleId, dlcList) {
        if (!jackettUrl) {
            // Load from automation settings first
            $.get('/api/settings/automation', function(result) {
                if (result.success && result.automation?.jackett?.url) {
                    jackettUrl = result.automation.jackett.url;
                    if (jackettUrl && !jackettUrl.endsWith('/')) {
                        jackettUrl += '/';
                    }
                    localStorage.setItem('jackettUrl', jackettUrl);
                    performDLCSearch(gameName, dlcList);
                } else {
                    $('#jackettUrlInput').val(jackettUrl);
                    $('#jackettConfigModal').modal('show');
                }
            }).fail(function() {
                $('#jackettUrlInput').val(jackettUrl);
                $('#jackettConfigModal').modal('show');
            });
        } else {
            performDLCSearch(gameName, dlcList);
        }
    }
    
    function performDLCSearch(gameName, dlcList) {
        const query = buildDLCSearchQuery(gameName, dlcList);
        const searchUrl = `${jackettUrl}UI/Dashboard#search=${encodeURIComponent(query)}&tracker=&category=`;
        window.open(searchUrl, '_blank');
    }
    
    function copySearchQuery(gameName, type, titleId, version) {
        const query = buildSearchQuery(gameName, type, titleId, version);
        navigator.clipboard.writeText(query).then(function() {
            // Show temporary success message
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            }, 2000);
        });
    }
    
    function copyDLCSearchQuery(gameName, dlcList) {
        const query = buildDLCSearchQuery(gameName, dlcList);
        navigator.clipboard.writeText(query).then(function() {
            // Show temporary success message
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
            }, 2000);
        });
    }

    // Smart Search Functions
    let currentSearchQuery = '';
    let currentSearchType = '';
    let currentTitleId = '';
    
    function smartSearch(gameName, type, titleId, version) {
        currentSearchQuery = buildSearchQuery(gameName, type, titleId, version);
        currentSearchType = type;
        currentTitleId = titleId;
        
        // Show modal
        $('#jackettSearchModal').modal('show');
        $('#searchLoading').removeClass('d-none');
        $('#searchError').addClass('d-none');
        $('#searchResults').addClass('d-none');
        
        // Perform API search
        $.ajax({
            url: '/api/jackett/search',
            type: 'POST',
            data: JSON.stringify({
                query: currentSearchQuery,
                type: type,
                title_id: titleId
            }),
            contentType: 'application/json',
            success: function(result) {
                $('#searchLoading').addClass('d-none');
                
                if (result.success) {
                    displaySearchResults(result.results, result.total);
                } else {
                    showSearchError(result.message || 'Search failed');
                }
            },
            error: function(xhr) {
                $('#searchLoading').addClass('d-none');
                let errorMsg = 'Search failed';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                showSearchError(errorMsg);
            }
        });
    }
    
    function smartSearchDLC(gameName, titleId, dlcList) {
        currentSearchQuery = buildDLCSearchQuery(gameName, dlcList);
        currentSearchType = 'dlc';
        currentTitleId = titleId;
        
        smartSearch(gameName, 'dlc', titleId);
    }
    
    function displaySearchResults(results, total) {
        $('#searchResults').removeClass('d-none');
        $('#searchResultCount').text(`Found ${total} results (showing top ${results.length})`);
        
        const tbody = $('#searchResultsBody');
        tbody.empty();
        
        if (results.length === 0) {
            tbody.append('<tr><td colspan="6" class="text-center">No results found</td></tr>');
            return;
        }
        
        results.forEach(result => {
            const row = $('<tr>');
            
            // Title with highlights
            let titleHtml = escapeHtml(result.title);
            if (result.has_title_id) {
                titleHtml = titleHtml.replace(new RegExp(currentTitleId, 'gi'), 
                    '<span class="badge bg-success">$&</span>');
            }
            if (result.relevance && result.relevance > 1) {
                titleHtml = '<i class="bi bi-star-fill text-warning me-1"></i>' + titleHtml;
            }
            
            row.append(`<td>${titleHtml}</td>`);
            row.append(`<td>${result.size_formatted}</td>`);
            row.append(`<td><span class="badge bg-success">${result.seeders}</span></td>`);
            row.append(`<td><span class="badge bg-secondary">${result.leechers}</span></td>`);
            row.append(`<td>${escapeHtml(result.indexer)}</td>`);
            
            // Actions
            const actions = $('<td>');
            if (result.magnet_link) {
                actions.append(`
                    <button class="btn btn-sm btn-success me-1" onclick="downloadTorrent('${escapeHtml(result.magnet_link)}', '${escapeHtml(result.title)}')" 
                            title="Download to qBittorrent">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="copyMagnet('${escapeHtml(result.magnet_link)}')" 
                            title="Copy magnet link">
                        <i class="bi bi-magnet"></i>
                    </button>
                `);
            }
            if (result.link) {
                actions.append(`
                    <a href="${escapeHtml(result.link)}" target="_blank" 
                       class="btn btn-sm btn-secondary" title="Open torrent page">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                `);
            }
            
            row.append(actions);
            tbody.append(row);
        });
    }
    
    function showSearchError(message) {
        $('#searchError').text(message).removeClass('d-none');
    }
    
    function openJackettWeb() {
        performSearch(currentSearchQuery.split(' ')[0], currentSearchType, currentTitleId);
    }
    
    function copyMagnet(magnetLink) {
        navigator.clipboard.writeText(magnetLink).then(function() {
            // Show temporary success message
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-primary');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function downloadTorrent(magnetLink, title) {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        
        // Show downloading state
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        btn.disabled = true;
        
        $.ajax({
            url: '/api/automation/download',
            type: 'POST',
            data: JSON.stringify({
                magnet_link: magnetLink
            }),
            contentType: 'application/json',
            success: function(result) {
                // Show success
                btn.innerHTML = '<i class="bi bi-check-circle"></i>';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-info');
                
                // Show toast notification
                showNotification('success', `Added "${title}" to qBittorrent`);
                
                // Track the download if we got a hash
                if (result.info_hash) {
                    activeDownloads.set(result.info_hash, {
                        name: title,
                        hash: result.info_hash,
                        startTime: Date.now()
                    });
                    refreshActiveDownloads();
                }
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-success');
                    btn.disabled = false;
                }, 3000);
            },
            error: function(xhr) {
                // Show error
                btn.innerHTML = '<i class="bi bi-x-circle"></i>';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-danger');
                
                let errorMsg = 'Failed to add torrent';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                }
                
                showNotification('error', errorMsg);
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                    btn.disabled = false;
                }, 3000);
            }
        });
    }
    
    function refreshActiveDownloads() {
        $.get('/api/automation/active-downloads', function(result) {
            if (result.success && result.downloads.length > 0) {
                $('#activeDownloadsSection').show();
                renderActiveDownloads(result.downloads);
            } else {
                $('#activeDownloadsSection').hide();
            }
        });
    }
    
    function renderActiveDownloads(downloads) {
        const grid = $('#activeDownloadsGrid');
        grid.empty();
        
        downloads.forEach(download => {
            const progressPercent = Math.round(download.progress);
            const speedMB = (download.dlspeed / 1024 / 1024).toFixed(2);
            const downloadedGB = (download.downloaded / 1024 / 1024 / 1024).toFixed(2);
            const sizeGB = (download.size / 1024 / 1024 / 1024).toFixed(2);
            const etaFormatted = formatETA(download.eta);
            
            const card = $(`
                <div class="col-md-6 col-lg-4">
                    <div class="card text-bg-dark">
                        <div class="card-body">
                            <h6 class="card-title text-truncate" title="${download.name}">${download.name}</h6>
                            <div class="progress mb-2" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: ${progressPercent}%"
                                     aria-valuenow="${progressPercent}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${progressPercent}%
                                </div>
                            </div>
                            <div class="small">
                                <div class="row">
                                    <div class="col-6">
                                        <i class="bi bi-speedometer2"></i> ${speedMB} MB/s
                                    </div>
                                    <div class="col-6 text-end">
                                        <i class="bi bi-clock"></i> ${etaFormatted}
                                    </div>
                                </div>
                                <div class="row mt-1">
                                    <div class="col-6">
                                        <i class="bi bi-hdd"></i> ${downloadedGB}/${sizeGB} GB
                                    </div>
                                    <div class="col-6 text-end">
                                        <i class="bi bi-people"></i> ${download.num_seeds}/${download.num_leechs}
                                    </div>
                                </div>
                                <div class="mt-1">
                                    <span class="badge bg-${getStateColor(download.state)}">${download.state}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            grid.append(card);
        });
    }
    
    function formatETA(seconds) {
        if (seconds >= 8640000) return '∞';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
            return `${minutes}m`;
        } else {
            return `${seconds}s`;
        }
    }
    
    function getStateColor(state) {
        const stateLower = state.toLowerCase();
        if (stateLower.includes('downloading')) return 'primary';
        if (stateLower.includes('stalled')) return 'warning';
        if (stateLower.includes('paused')) return 'secondary';
        if (stateLower.includes('queued')) return 'info';
        if (stateLower.includes('error') || stateLower.includes('missing')) return 'danger';
        if (stateLower.includes('checking')) return 'info';
        if (stateLower.includes('moving')) return 'warning';
        return 'secondary';
    }
    
    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        $('#autoRefreshText').text(`Auto-refresh: ${autoRefreshEnabled ? 'ON' : 'OFF'}`);
        
        if (autoRefreshEnabled) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    }
    
    function startAutoRefresh() {
        if (refreshInterval) return;
        
        refreshInterval = setInterval(() => {
            if (activeDownloads.size > 0 || $('#activeDownloadsSection').is(':visible')) {
                refreshActiveDownloads();
            }
        }, 5000); // Refresh every 5 seconds
    }
    
    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }
    
    function showNotification(type, message) {
        // Create toast element
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        
        // Add toast container if it doesn't exist
        if ($('#toastContainer').length === 0) {
            $('body').append('<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
        }
        
        const toastElement = $(toastHtml);
        $('#toastContainer').append(toastElement);
        
        const toast = new bootstrap.Toast(toastElement[0]);
        toast.show();
        
        // Remove toast element after it's hidden
        toastElement[0].addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }

    $(document).ready(function() {
        fetchMissingContent();
        
        $('#exportBtn').click(exportMissingList);
        
        // Load Jackett URL from automation settings if not in localStorage
        if (!jackettUrl) {
            $.get('/api/settings/automation', function(result) {
                if (result.success && result.automation?.jackett?.url) {
                    jackettUrl = result.automation.jackett.url;
                    if (jackettUrl && !jackettUrl.endsWith('/')) {
                        jackettUrl += '/';
                    }
                    localStorage.setItem('jackettUrl', jackettUrl);
                }
            });
        }
        
        // Check for active downloads on load
        refreshActiveDownloads();
        
        // Start auto-refresh
        startAutoRefresh();
    });
</script>
{% endblock %}