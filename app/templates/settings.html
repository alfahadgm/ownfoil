{% extends "base.html" %}
{% block content %}
{% include 'nav.html' %}

<div class="container-fluid setting-body">
    <div class="row">
        <div class="col">
            <div class="settings-container container mt-3">

                <!-- <h1>Settings</h1> -->

                {% if admin_account_created == false %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Missing admin account!</h4>
                    <p>Ownfoil requires an admin account to enable authentication. Until an account with admin rights is
                        created, <strong>authentication is disabled, anyone can access and change the configuration of
                            your shop!</strong>
                        <br>
                        Add an admin account <a href="/settings#Authentication" class="alert-link">here under
                            Authentication</a>.
                    </p>
                </div>
                {% endif %}

                {% if valid_keys == false %}
                <div id="missingKeysAlert" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading">Missing console keys!</h4>
                    Console keys are required to decrypt any Nintendo content, including
                    backups. Ownfoil uses this to identify files, regardless of the filename.</br>
                    <strong>Titles will be missed or misidentified if you don't fill in your keys!</strong>
                    See <a target="_blank" href="https://gitlab.com/easyhacking/switch/-/wikis/home/getting-started/dump-keys" class="alert-link">this guide</a> on
                    how to extract the
                    keys from your console, and upload them <a href="/settings#consoleKeysInput" class="alert-link">here
                        in Ownfoil.</a>
                    <hr>
                    If keys are missing, all files <strong>must follow the format "Title Name
                        [TITLEID][vVERSION]"</strong>, else the file won't be recognized.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <div id="missingShopHostAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                    <h4 class="alert-heading">Missing shop Host!</h4>
                    Host verification from outside the local network is disabled if the shop <code>Host</code> is
                    missing, configure it <a href="/settings#shopHostInput" class="alert-link">here
                        in Ownfoil</a> to prevent someone else stealing from your shop.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div id="missingShopHauthAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                    <h4 class="alert-heading">Missing shop Hauth!</h4>
                    <a href="https://blawar.github.io/tinfoil/network/#host-signature" class="alert-link"
                        target="_blank">Host signature</a> verification from outside the local network is disabled if
                    the shop <code>Hauth</code> is missing. Connect to the shop from Tinfoil with an admin account to
                    set it.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <h2 id="Authentication" class="pb-3">Authentication</h2>

                <table class="table table-hover caption-top" id="userTable">
                    <caption>List of users:</caption>
                    <thead>
                        <tr>
                            <th scope="col">User</th>
                            <th scope="col">Permissions</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

                <p class="d-inline-flex gap-1">
                    <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseNewUser" aria-expanded="false" aria-controls="collapseNewUser">
                        Add new user
                    </button>
                </p>
                <div class="collapse" id="collapseNewUser">
                    <div class="card card-body">
                        <label class="form-label">Add a new user:</label>
                        <form class="row g-3">
                            <div class="col-auto">
                                <label for="inputNewUser" class="visually-hidden">Email</label>
                                <input type="text" class="form-control" id="inputNewUser" placeholder="Username">
                            </div>
                            <div class="col-auto">
                                <label for="inputNewUserPassword" class="visually-hidden">Password</label>
                                <input type="password" class="form-control" id="inputNewUserPassword"
                                    placeholder="Password">
                            </div>
                            <div class="col-auto p-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="checkboxNewUserShopAccess"
                                        checked>
                                    <label class="form-check-label" for="checkboxNewUserShopAccess">Shop Access</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="checkboxNewUserBackupAccess">
                                    <label class="form-check-label" for="checkboxNewUserBackupAccess">Backup
                                        Access</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="checkboxNewUserAdminAccess">
                                    <label class="form-check-label" for="checkboxNewUserAdminAccess">Admin
                                        Access</label>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-primary mb-3"
                                    onClick='submitNewUser()'>Submit</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete User Modal -->
                <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="deleteUserModalLabel">Delete user</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ...
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <h2 class="pb-3">Library</h2>

                <label class="form-label">Library paths:</label>
                <div id="libraryPathHelp" class="form-text">Path of directory containing your games.</div>
                <table class="table table-hover caption-top" id="pathsTable">
                    <thead>
                        <tr>
                            <th scope="col">Path</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

                <!-- Library buttons -->
                <div class="row g-3">
                    <div class="col-auto">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseNewPath" aria-expanded="false" aria-controls="collapseNewPath">
                            Add library path
                        </button>
                    </div>

                    <div class="col-auto">
                        <button type="button" class="btn btn-primary mb-3 scanBtn" onClick='scanLibrary()'>Scan
                            library</button>
                    </div>
                    
                    <div class="col-auto">
                        <button type="button" class="btn btn-warning mb-3" onClick='showOrganizeLibraryModal()'>
                            <i class="bi bi-folder-fill"></i> Organize Library
                        </button>
                    </div>
                    
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger mb-3" onClick='showCleanupDuplicatesModal()'>
                            <i class="bi bi-trash-fill"></i> Clean Duplicates
                        </button>
                    </div>
                </div>

                <div class="collapse" id="collapseNewPath">
                    <div class="card card-body">
                        <label class="form-label">Add a new directory:</label>
                        <div class="row g-3">
                            <div class="col-6">
                                <input type="text" class="form-control" id="libraryPathInput" placeholder="Path">
                            </div>
                            <div class="col-auto">
                                <button type="button" id="submitNewLibraryPathBtn" class="btn btn-primary mb-3"
                                    onClick='submitNewLibraryPath()'>Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete User Modal -->
                <div class="modal fade" id="deletePathModal" tabindex="-1" aria-labelledby="deletePathModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="deletePathModalLabel">Delete library path</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ...
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>
                <h2 class="pb-3">Titles</h2>
                <p>Titles identification configuration.</p>
                <div class="row mb-3">
                    <div class="col">
                        <label for="selectRegion" class="form-label">Library Region:</label>
                        <select id="selectRegion" class="form-select" aria-label="Select library region">
                        </select>
                    </div>
                    <div class="col">
                        <label for="selectLanguage" class="form-label">Library Language:</label>
                        <select id="selectLanguage" class="form-select" aria-label="Select library language">
                        </select>
                    </div>
                    <div id="selectRegionLanguageHelp" class="form-text">Region and Language used to get games
                        informations.</div>
                </div>

                <div class="mb-3">
                    <label for="consoleKeysInput" class="form-label">Console keys:</label>
                    <input class="form-control {% if valid_keys == true %}is-valid d-none{% endif %}" type="file"
                        accept=".keys,.txt" id="consoleKeysInput">
                    <div class="valid-feedback">
                        Keys are valid!
                    </div>
                    <div id="invalidConsoleKeysFeedback" class="invalid-feedback">
                        Invalid keys file!
                    </div>
                    <div id="consoleKeysHelp" class="form-text">Console keys are required to decrypt any Nintendo
                        content, including
                        backups. Ownfoil uses this to identify files, regardless of the filename.
                    </div>
                </div>

                <div class="mb-3">
                    <button type="button" id="submitTitlesSettingsBtn" class="btn btn-primary"
                        onClick='submitTitlesSettings()'>Submit</button>
                </div>
                </form>
                <hr>

                <h2 class="pb-3">Shop</h2>
                <!-- Shop URL -->
                <div class="mb-3">
                    <label for="shopHostInput" class="form-label">Shop URL:</label>
                    <input class="form-control" id="shopHostInput" aria-describedby="shopHostHelp"
                        placeholder="shop.domain.tld">
                    <div id="shopHostHelp" class="form-text">Configure your shop URL to enable host verification.<br>
                        Host verification from Tinfoil requests will be enforced if the shop is accessed securely (with
                        <code>https</code>), make sure your reverse proxy <strong>does NOT</strong> allow insecure
                        connections (or upgrades them to use SSL) and correctly sets the <code>X-Forwarded-Proto</code>
                        header.
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="publicShopCheck"
                        aria-describedby="publicShopCheckHelp">
                    <label class="form-check-label" for="publicShopCheck">Public shop</label>
                    <div id="publicShopCheckHelp" class="form-text">If enabled, Shop access from Tinfoil does not
                        require authentication.
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="encryptShopCheck"
                        aria-describedby="encryptShopCheckHelp">
                    <label class="form-check-label" for="encryptShopCheck">Encrypt shop</label>
                    <div id="encryptShopCheckHelp" class="form-text">Serve encrypted and compressed shop, so that only Tinfoil clients
                        can access the content. <strong>Strongly suggested to enable it for security</strong>.</div>
                </div>

                <div class="mb-3">
                    <label for="motdTextArea" class="form-label">Message of the day:</label>
                    <textarea class="form-control" id="motdTextArea" rows="3"></textarea>
                    <div id="motdTextAreaHelp" class="form-text">Message presented when opening Tinfoil after
                        successfully loading your shop.</div>
                </div>

                <div class="mb-3">
                    <button type="button" id="submitShopSettingsBtn" class="btn btn-primary"
                        onClick='submitShopSettings()'>Submit</button>
                </div>

                <hr>

                <h2 class="pb-3">Automation</h2>
                <p>Configure automation services for game management.</p>
                
                <!-- qBittorrent Configuration -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">qBittorrent Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="qbitUrlInput" class="form-label">qBittorrent URL:</label>
                            <input class="form-control" id="qbitUrlInput" placeholder="http://localhost:8080" aria-describedby="qbitUrlHelp">
                            <div id="qbitUrlHelp" class="form-text">URL to your qBittorrent Web UI (e.g., http://localhost:8080)</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="qbitUsernameInput" class="form-label">Username:</label>
                                    <input class="form-control" id="qbitUsernameInput" placeholder="admin">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="qbitPasswordInput" class="form-label">Password:</label>
                                    <input type="password" class="form-control" id="qbitPasswordInput" placeholder="Password">
                                    <div class="form-text text-warning">Note: Password is stored in plain text</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="qbitCategoryInput" class="form-label">Category:</label>
                            <input class="form-control" id="qbitCategoryInput" placeholder="nintendo-switch" aria-describedby="qbitCategoryHelp">
                            <div id="qbitCategoryHelp" class="form-text">Category to use for Switch games in qBittorrent</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="testConnection('qbittorrent')">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Test Connection
                        </button>
                        <span id="qbitTestResult" class="ms-2"></span>
                    </div>
                </div>
                
                <!-- Jackett Configuration -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Jackett Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="jackettUrlInput" class="form-label">Jackett URL:</label>
                            <input class="form-control" id="jackettUrlInput" placeholder="http://localhost:9117" aria-describedby="jackettUrlHelp">
                            <div id="jackettUrlHelp" class="form-text">URL to your Jackett instance (e.g., http://localhost:9117)</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="testConnection('jackett')">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Test Connection
                        </button>
                        <span id="jackettTestResult" class="ms-2"></span>
                    </div>
                </div>
                
                <!-- Processing Options -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Processing Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="autoExtractCheck" checked>
                            <label class="form-check-label" for="autoExtractCheck">
                                Automatically extract archives (RAR, ZIP, 7Z)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="autoOrganizeCheck" checked>
                            <label class="form-check-label" for="autoOrganizeCheck">
                                Automatically organize files into GameName/TYPE structure
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="useHardlinksCheck" checked>
                            <label class="form-check-label" for="useHardlinksCheck">
                                Use hardlinks when possible (saves disk space)
                            </label>
                            <div class="form-text">Note: Hardlinks require source and destination on same filesystem</div>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="deleteAfterProcessCheck">
                            <label class="form-check-label" for="deleteAfterProcessCheck">
                                Delete source files after successful processing
                            </label>
                            <div class="form-text text-danger">Warning: This permanently deletes processed files</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button type="button" id="submitAutomationSettingsBtn" class="btn btn-primary"
                        onClick='submitAutomationSettings()'>Submit</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>

    settings_map = {
        'library/path': 'libraryPathInput'
    };


    // allUsers = [];

    function getInputVal(inputId) {
        return $("#" + inputId).val();
    };

    function setInputVal(inputId, value) {
        return $("#" + inputId).val(value);
    };

    function getCheckboxStatus(checkboxId) {
        return $('#' + checkboxId).is(":checked")
    }

    function scanLibrary(path = null) {
        $('.scanBtn').prop('disabled', true);
        data = {
            path: path
        }
        $.ajax({
            url: '/api/library/scan',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    if (result['status_code'] == '302') {
                        window.location.href = result['location']
                        return
                    }
                    console.log('Scan Success!');
                }
                $('.scanBtn').prop('disabled', false);
            }
        });

    }

    function fillLibraryTable() {
        $('#pathsTable tbody').empty();

        $.getJSON("/api/settings/library/paths", function (result) {

            if (!result['success']) {
                if (result['status_code'] == '302') {
                    window.location.href = result['location']
                    return
                }
            }
            paths = result.paths;
            if (paths === null || !paths.length) {
                $('#pathsTable tbody').append(
                    '<tr><td>-</td><td>-</td><td>');
            } else {
                paths.forEach(path => {
                    $('#pathsTable tbody').append(
                        '<tr><td>' + path + '</td>'
                        + '<td>' +
                        '<button type="button" class="btn btn-outline-info btn-sm scanBtn" onclick=\'scanLibrary("' + path + '");\' ><i class="bi bi-arrow-clockwise"></i></button> ' +
                        '<button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePathModal" data-bs-path="' + path + '"\'><i class="bi bi-x-circle"></i></button>' +
                        '</td></tr>');
                })
            }
        });

    }

    function fillUserTable() {
        $('#userTable tbody').empty();
        $.getJSON("/api/users", function (result) {
            if (!result['success']) {
                if (result['status_code'] == '302') {
                    window.location.href = result['location']
                    return
                }
            }
            allUsers = result;
            allUsernames = [];
            if (!result.length) {
                $('#userTable tbody').append(
                    '<tr><td>-</td><td>-</td><td>-</td></tr>');
            }
            result.forEach(user => {
                allUsernames.push(user['user']);
                base_input = '<input class="form-check-input" type="checkbox" onclick="return false" checked>';
                shop_input = base_input;
                backup_input = base_input;
                admin_input = base_input;
                if (!user['shop_access']) {
                    shop_input = shop_input.replace(' checked', '');
                }
                if (!user['backup_access']) {
                    backup_input = backup_input.replace(' checked', '');
                }
                if (!user['admin_access']) {
                    admin_input = shop_input.replace(' checked', '');
                }
                $('#userTable tbody').append(
                    '<tr><td>' + user['user'] + '</td><td>'
                    + `
                        <div class="form-check form-check-inline">`
                    + shop_input + `
                            <label class="form-check-label">Shop</label>
                        </div>
                        <div class="form-check form-check-inline">`
                    + backup_input + `
                            <label class="form-check-label">Backup</label>
                        </div>
                        <div class="form-check form-check-inline">`
                    + admin_input + `
                            <label class="form-check-label">Admin</label>
                        </div>`
                    + '</td><td>' +
                    '<button type="button" class="btn btn-outline-info btn-sm" disabled=""><i class="bi bi-pencil-square"></i></button> ' +
                    '<button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteUserModal" data-bs-id="' + user['id'] + '" data-bs-user="' + user['user'] + '"\'><i class="bi bi-x-circle"></i></button>' +
                    '</td></tr>');
            });
        })

    }

    const deletePathModal = $('#deletePathModal')
    if (deletePathModal) {
        deletePathModal.on('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const path = button.getAttribute('data-bs-path')
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.

            // Update the modal's content.
            // const modalTitle = deletePathModal.querySelector('.modal-title')
            const modalBody = deletePathModal.find('.modal-body')
            const deleteBtn = deletePathModal.find('.btn-danger')


            deleteBtn.attr('onClick', 'deleteLibraryPath("' + path + '");');

            // modalTitle.textContent = `New message to ${recipient}`
            modalBody.text("Delete path " + path + " ?")
        })
    }

    const deleteUserModal = $('#deleteUserModal')
    if (deleteUserModal) {
        deleteUserModal.on('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const user = button.getAttribute('data-bs-user')
            const id = button.getAttribute('data-bs-id')
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.

            // Update the modal's content.
            // const modalTitle = deleteUserModal.querySelector('.modal-title')
            const modalBody = deleteUserModal.find('.modal-body')
            const deleteBtn = deleteUserModal.find('.btn-danger')


            deleteBtn.attr('onClick', 'deleteUser(' + id + ');');

            // modalTitle.textContent = `New message to ${recipient}`
            modalBody.text("Delete user " + user + " ?")
        })
    }

    function deleteUser(userId) {
        data = {
            user_id: userId
        }
        $.ajax({
            url: "/api/user",
            type: 'DELETE',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    fillUserTable();
                }
            }
        });
    }

    function deleteLibraryPath(path) {
        data = {
            path: path
        }
        $.ajax({
            url: "/api/settings/library/paths",
            type: 'DELETE',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    fillLibraryTable();
                }
            }
        });
    }

    $('#checkboxNewUserAdminAccess').change(function () {
        if (this.checked != false) {
            $('#checkboxNewUserShopAccess').prop('checked', true).attr("disabled", true);
            $('#checkboxNewUserBackupAccess').prop('checked', true).attr("disabled", true);

        } else {
            $('#checkboxNewUserShopAccess').attr("disabled", false);
            $('#checkboxNewUserBackupAccess').attr("disabled", false);

        }
    });

    function submitNewUser() {
        formOk = true;
        user = getInputVal("inputNewUser")
        password = getInputVal("inputNewUserPassword")
        shop_access = getCheckboxStatus("checkboxNewUserShopAccess")
        backup_access = getCheckboxStatus("checkboxNewUserBackupAccess")
        admin_access = getCheckboxStatus("checkboxNewUserAdminAccess")

        if (user == '') {
            $('#inputNewUser').addClass('is-invalid');
            formOk = false;
        } else if (allUsernames.includes(user)) {
            $('#inputNewUser').addClass('is-invalid');
            formOk = false;
        } else {
            $('#inputNewUser').removeClass('is-invalid');
        }

        if (password == '') {
            $('#inputNewUserPassword').addClass('is-invalid');
            formOk = false;
        } else {
            $('#inputNewUserPassword').removeClass('is-invalid');
        }


        if (formOk) {
            data = {
                user: user,
                password: password,
                shop_access: shop_access,
                backup_access: backup_access,
                admin_access: admin_access,
            }

            $.ajax({
                url: "/api/user/signup",
                type: 'POST',
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (result) {
                    if (result['success']) {
                        if (result['status_code'] == '302') {
                            window.location.href = result['location']
                            return
                        }
                        console.log('Signup Success!');
                        setInputVal("inputNewUser", "")
                        setInputVal("inputNewUserPassword", "")
                        fillUserTable();
                    }
                }
            });
        }
    }

    function submitNewLibraryPath() {
        $('#submitNewLibraryPathBtn').prop('disabled', true);
        path = getInputVal("libraryPathInput").trim();
        data = {
            path: path
        }

        $.ajax({
            url: "/api/settings/library/paths",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    if (result['status_code'] == '302') {
                        window.location.href = result['location']
                        return
                    }
                    console.log('Sucessfully added path ' + path);
                    setInputVal("libraryPathInput", "")
                    fillLibraryTable();
                } else {
                    console.log('Error adding path ' + path);
                }
                $('#submitNewLibraryPathBtn').prop('disabled', false);
            }
        });
    }

    function submitTitlesSettings() {
        $('#submitTitlesSettingsBtn').prop('disabled', true);
        data = {
            region: getInputVal("selectRegion"),
            language: getInputVal("selectLanguage"),
        }
        file = $('#consoleKeysInput').prop('files')[0];

        if (file != undefined) {
            formData = new FormData();
            formData.append("file", file);
            $.ajax({
                url: "/api/upload",
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                success: function (result) {
                    if (result['success']) {
                        $('#consoleKeysInput').removeClass('is-invalid');
                        $('#consoleKeysInput').addClass('is-valid');
                        $('#missingKeysAlert').addClass('d-none');
                    } else {
                        $('#invalidConsoleKeysFeedback').text("Invalid keys file! Invalid keys detected: " + result['errors'].join(', '));
                        $('#consoleKeysInput').addClass('is-invalid');
                    }
                }
            });
        }

        $.ajax({
            url: "/api/settings/titles",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (!result['success']) {
                    console.log('Not Success!');
                    result['errors'].forEach(error => {
                        path = error['path'];
                        formId = settings_map[path];
                        form = $('#' + formId);
                        form.addClass('is-invalid');
                        formTextElement = form.attr('aria-describedby');
                        $("#" + formTextElement).addClass('invalid-feedback');
                        $("#" + formTextElement).text(error['error']);
                    });
                }
                $('#submitTitlesSettingsBtn').prop('disabled', false);
            }
        });
    }

    function submitShopSettings() {
        $('#submitShopSettingsBtn').prop('disabled', true);
        data = {
            host: $('#shopHostInput').val(),
            public: getCheckboxStatus("publicShopCheck"),
            encrypt: getCheckboxStatus("encryptShopCheck"),
            motd: $('#motdTextArea').val(),
        }

        $.ajax({
            url: "/api/settings/shop",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (!result['success']) {
                    console.log('Not Success!');
                    result['errors'].forEach(error => {
                        path = error['path'];
                        formId = settings_map[path];
                        form = $('#' + formId);
                        form.addClass('is-invalid');
                        formTextElement = form.attr('aria-describedby');
                        $("#" + formTextElement).addClass('invalid-feedback');
                        $("#" + formTextElement).text(error['error']);
                    });
                }
                $('#submitShopSettingsBtn').prop('disabled', false);
            }
        });
    }

    function testConnection(service) {
        const btn = event.target.closest('button');
        const spinner = btn.querySelector('.spinner-border');
        const resultSpan = document.getElementById(service === 'qbittorrent' ? 'qbitTestResult' : 'jackettTestResult');
        
        // Show spinner
        spinner.classList.remove('d-none');
        btn.disabled = true;
        resultSpan.textContent = '';
        resultSpan.className = '';
        
        $.ajax({
            url: '/api/automation/test',
            type: 'POST',
            data: JSON.stringify({ service: service }),
            contentType: "application/json",
            success: function(result) {
                spinner.classList.add('d-none');
                btn.disabled = false;
                
                if (result.success) {
                    resultSpan.className = 'text-success';
                    resultSpan.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message;
                } else {
                    resultSpan.className = 'text-danger';
                    resultSpan.innerHTML = '<i class="bi bi-x-circle"></i> ' + result.message;
                }
            },
            error: function() {
                spinner.classList.add('d-none');
                btn.disabled = false;
                resultSpan.className = 'text-danger';
                resultSpan.innerHTML = '<i class="bi bi-x-circle"></i> Connection test failed';
            }
        });
    }
    
    function submitAutomationSettings() {
        $('#submitAutomationSettingsBtn').prop('disabled', true);
        
        const automationConfig = {
            qbittorrent: {
                url: $('#qbitUrlInput').val().trim(),
                username: $('#qbitUsernameInput').val().trim(),
                password: $('#qbitPasswordInput').val().trim(),
                category: $('#qbitCategoryInput').val().trim() || 'nintendo-switch'
            },
            jackett: {
                url: $('#jackettUrlInput').val().trim()
            },
            processing: {
                auto_extract: $('#autoExtractCheck').is(':checked'),
                auto_organize: $('#autoOrganizeCheck').is(':checked'),
                use_hardlinks: $('#useHardlinksCheck').is(':checked'),
                delete_after_process: $('#deleteAfterProcessCheck').is(':checked')
            }
        };
        
        $.ajax({
            url: '/api/settings/automation',
            type: 'POST',
            data: JSON.stringify({ automation: automationConfig }),
            contentType: "application/json",
            success: function(result) {
                if (result.success) {
                    // Show success message
                    const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                        'Automation settings saved successfully!' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');
                    $('#submitAutomationSettingsBtn').parent().prepend(alert);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => alert.alert('close'), 3000);
                } else {
                    // Show error messages
                    const errorList = result.errors.map(e => `<li>${e}</li>`).join('');
                    const alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                        '<strong>Error saving settings:</strong><ul>' + errorList + '</ul>' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');
                    $('#submitAutomationSettingsBtn').parent().prepend(alert);
                }
                $('#submitAutomationSettingsBtn').prop('disabled', false);
            },
            error: function() {
                const alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                    'Failed to save automation settings' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>');
                $('#submitAutomationSettingsBtn').parent().prepend(alert);
                $('#submitAutomationSettingsBtn').prop('disabled', false);
            }
        });
    }

    $(document).ready(function () {
        fillUserTable();
        fillLibraryTable();

        $.getJSON("/api/settings", function (result) {
            Object.keys(languages).forEach(function (key) {
                $('#selectRegion').append(`<option value="${key}">${key}</option>`);
            });

            $('#selectRegion').on('change', function () {
                $('#selectLanguage').empty()
                region = $(this).find(":selected").val();
                availableLanguages = languages[region];
                availableLanguages.forEach(function (key) {
                    $('#selectLanguage').append(`<option value="${key}">${key}</option>`);
                });
            });


            // Library settings
            librarySettings = result['library'];
            // Titles settings
            titlesSettings = result['titles'];

            // Fill region and language
            setInputVal("selectRegion", titlesSettings['region']);
            $('#selectRegion').trigger('change');
            setInputVal("selectLanguage", titlesSettings['language']);

            // Shop settings
            shopSettings = result['shop'];
            setInputVal("shopHostInput", shopSettings['host']);
            setInputVal("motdTextArea", shopSettings['motd']);
            $("#publicShopCheck").prop("checked", shopSettings['public']);
            $("#encryptShopCheck").prop("checked", shopSettings['encrypt']);
            if (!shopSettings['host']) {
                $("#missingShopHostAlert").css('display', '');
            } else if (!shopSettings['hauth']) {
                $("#missingShopHauthAlert").css('display', '');
            }
            
            // Load automation settings
            $.getJSON("/api/settings/automation", function (result) {
                if (result.success && result.automation) {
                    const automation = result.automation;
                    
                    // qBittorrent settings
                    if (automation.qbittorrent) {
                        $('#qbitUrlInput').val(automation.qbittorrent.url || '');
                        $('#qbitUsernameInput').val(automation.qbittorrent.username || '');
                        $('#qbitPasswordInput').val(automation.qbittorrent.password || '');
                        $('#qbitCategoryInput').val(automation.qbittorrent.category || 'nintendo-switch');
                    }
                    
                    // Jackett settings
                    if (automation.jackett) {
                        $('#jackettUrlInput').val(automation.jackett.url || '');
                    }
                    
                    // Processing settings
                    if (automation.processing) {
                        $('#autoExtractCheck').prop('checked', automation.processing.auto_extract !== false);
                        $('#autoOrganizeCheck').prop('checked', automation.processing.auto_organize !== false);
                        $('#useHardlinksCheck').prop('checked', automation.processing.use_hardlinks !== false);
                        $('#deleteAfterProcessCheck').prop('checked', automation.processing.delete_after_process === true);
                    }
                }
            });
        });

    });
    {% if admin_account_created == false %}
    $('#checkboxNewUserAdminAccess').prop('checked', true).attr("disabled", true);
    $('#checkboxNewUserShopAccess').prop('checked', true).attr("disabled", true);
    $('#checkboxNewUserBackupAccess').prop('checked', true).attr("disabled", true);
    {% endif %}
    languages = {{ languages_from_titledb | tojson | safe }}
    
    // Library organization functions
    function showOrganizeLibraryModal() {
        $('#organizePreviewContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
        $('#organizeLibraryModal').modal('show');
        
        $.ajax({
            url: '/api/library/organize/preview',
            type: 'POST',
            data: JSON.stringify({organize_by_name: true}),
            contentType: "application/json",
            success: function(result) {
                let content = '';
                
                if (result.total_files === 0) {
                    content = '<div class="alert alert-info">Your library is already organized!</div>';
                } else {
                    content = `
                        <div class="alert alert-info">
                            <strong>${result.total_files}</strong> files will be reorganized
                            (${formatBytes(result.total_size)})
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Current Path</th>
                                        <th>New Path</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.changes.forEach(change => {
                        content += `
                            <tr>
                                <td class="text-break small">${change.old_path}</td>
                                <td class="text-break small">${change.new_path}</td>
                            </tr>
                        `;
                    });
                    
                    content += '</tbody></table></div>';
                    
                    // Add checkbox for removing empty folders
                    content += `
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="removeEmptyFolders" checked>
                            <label class="form-check-label" for="removeEmptyFolders">
                                Remove empty folders after organizing
                            </label>
                        </div>
                    `;
                    
                    if (result.errors.length > 0) {
                        content += '<div class="alert alert-warning mt-3"><strong>Errors:</strong><ul>';
                        result.errors.forEach(error => {
                            content += `<li>${error.file}: ${error.error}</li>`;
                        });
                        content += '</ul></div>';
                    }
                }
                
                $('#organizePreviewContent').html(content);
                
                if (result.total_files > 0) {
                    $('#confirmOrganizeBtn').show().data('changes', result.changes);
                } else {
                    $('#confirmOrganizeBtn').hide();
                }
            },
            error: function() {
                $('#organizePreviewContent').html('<div class="alert alert-danger">Failed to preview organization</div>');
            }
        });
    }
    
    function confirmOrganizeLibrary() {
        const changes = $('#confirmOrganizeBtn').data('changes');
        const removeEmptyFolders = $('#removeEmptyFolders').is(':checked');
        $('#confirmOrganizeBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Organizing...');
        
        $.ajax({
            url: '/api/library/organize/apply',
            type: 'POST',
            data: JSON.stringify({changes: changes, dry_run: false, remove_empty_folders: removeEmptyFolders}),
            contentType: "application/json",
            success: function(result) {
                let content = `
                    <div class="alert alert-success">
                        Successfully organized ${result.total_success} files!
                    </div>
                `;
                
                if (result.total_errors > 0) {
                    content += '<div class="alert alert-danger"><strong>Errors occurred:</strong><ul>';
                    result.results.errors.forEach(error => {
                        content += `<li>${error.file}: ${error.error}</li>`;
                    });
                    content += '</ul></div>';
                }
                
                $('#organizePreviewContent').html(content);
                $('#confirmOrganizeBtn').hide();
                
                // Refresh the page after a delay
                setTimeout(function() {
                    location.reload();
                }, 2000);
            },
            error: function() {
                $('#organizePreviewContent').html('<div class="alert alert-danger">Failed to organize library</div>');
                $('#confirmOrganizeBtn').prop('disabled', false).html('Organize Library');
            }
        });
    }
    
    function showCleanupDuplicatesModal() {
        $('#duplicatesPreviewContent').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
        $('#cleanupDuplicatesModal').modal('show');
        $('#confirmCleanupBtn').hide();
        
        $.get('/api/library/duplicates', function(result) {
            let content = '';
            
            if (result.total_files === 0) {
                content = '<div class="alert alert-info">No duplicate files found! Your library is clean.</div>';
            } else {
                content = `
                    <div class="alert alert-warning">
                        <strong>${result.total_files}</strong> duplicate files found
                        (${formatBytes(result.total_size)} can be freed)
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Type</th>
                                    <th>Game</th>
                                    <th>File to Delete</th>
                                    <th>Reason</th>
                                    <th>Size</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Group duplicates by game for better readability
                const groupedDuplicates = {};
                result.duplicates.forEach(dup => {
                    if (!groupedDuplicates[dup.title_name]) {
                        groupedDuplicates[dup.title_name] = [];
                    }
                    groupedDuplicates[dup.title_name].push(dup);
                });
                
                // Sort games alphabetically
                const sortedGames = Object.keys(groupedDuplicates).sort();
                
                sortedGames.forEach(gameName => {
                    const gameDups = groupedDuplicates[gameName];
                    gameDups.forEach((dup, index) => {
                        const typeColor = dup.type === 'Update' ? 'warning' : (dup.type === 'Base' ? 'danger' : 'info');
                        const rowClass = index === 0 ? 'border-top border-secondary' : '';
                        
                        content += `
                            <tr class="${rowClass}">
                                <td><span class="badge bg-${typeColor}">${dup.type}</span></td>
                                <td class="text-break">${dup.title_name}</td>
                                <td class="text-break small">
                                    <span class="text-danger">${dup.filename || dup.filepath}</span>
                                    ${dup.version !== undefined ? `<br><small class="text-muted">Version: ${dup.version}</small>` : ''}
                                </td>
                                <td class="small">
                                    ${dup.reason}
                                    ${dup.kept_file ? `<br><small class="text-success">Keeping: ${dup.kept_file}</small>` : ''}
                                </td>
                                <td class="text-nowrap">${formatBytes(dup.size)}</td>
                            </tr>
                        `;
                    });
                });
                
                content += '</tbody></table></div>';
            }
            
            $('#duplicatesPreviewContent').html(content);
            
            if (result.total_files > 0) {
                $('#confirmCleanupBtn').show().data('duplicates', result.duplicates);
            } else {
                $('#confirmCleanupBtn').hide();
            }
        }).fail(function() {
            $('#duplicatesPreviewContent').html('<div class="alert alert-danger">Failed to find duplicates</div>');
        });
    }
    
    function confirmCleanupDuplicates() {
        const duplicates = $('#confirmCleanupBtn').data('duplicates');
        $('#confirmCleanupBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Deleting...');
        
        $.ajax({
            url: '/api/library/duplicates/delete',
            type: 'POST',
            data: JSON.stringify({duplicates: duplicates, dry_run: false}),
            contentType: "application/json",
            success: function(result) {
                let content = `
                    <div class="alert alert-success">
                        Successfully deleted ${result.total_deleted} files!
                        Freed ${formatBytes(result.space_freed)}
                    </div>
                `;
                
                if (result.total_errors > 0) {
                    content += '<div class="alert alert-danger"><strong>Errors occurred:</strong><ul>';
                    result.results.errors.forEach(error => {
                        content += `<li>${error.file}: ${error.error}</li>`;
                    });
                    content += '</ul></div>';
                }
                
                $('#duplicatesPreviewContent').html(content);
                $('#confirmCleanupBtn').hide();
                
                // Refresh the page after a delay
                setTimeout(function() {
                    location.reload();
                }, 2000);
            },
            error: function() {
                $('#duplicatesPreviewContent').html('<div class="alert alert-danger">Failed to delete duplicates</div>');
                $('#confirmCleanupBtn').prop('disabled', false).html('Delete Duplicates');
            }
        });
    }
    
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
</script>

<!-- Organize Library Modal -->
<div class="modal fade" id="organizeLibraryModal" tabindex="-1" aria-labelledby="organizeLibraryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="organizeLibraryModalLabel">Organize Library</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="organizePreviewContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmOrganizeBtn" onclick="confirmOrganizeLibrary()" style="display:none;">Organize Library</button>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Duplicates Modal -->
<div class="modal fade" id="cleanupDuplicatesModal" tabindex="-1" aria-labelledby="cleanupDuplicatesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cleanupDuplicatesModalLabel">Clean Duplicate Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="duplicatesPreviewContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmCleanupBtn" onclick="confirmCleanupDuplicates()" style="display:none;">Delete Duplicates</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}